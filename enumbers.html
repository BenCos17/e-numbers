<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Eâ€‘Number Lookup</title>
<style>
  :root {
    --bg-color: #f8f9fa;
    --text-color: #333;
    --table-bg: white;
    --table-border: #ccc;
    --header-bg: #e9ecef;
    --input-bg: white;
    --input-border: #ccc;
    --error-bg: #f8d7da;
    --error-border: #f5c6cb;
    --error-text: #dc3545;
    --loading-color: #6c757d;
    --placeholder-color: #bbb;
  }

  [data-theme="dark"] {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --table-bg: #2d2d2d;
    --table-border: #444;
    --header-bg: #3d3d3d;
    --input-bg: #2d2d2d;
    --input-border: #444;
    --error-bg: #3d1f1f;
    --error-border: #5c2a2a;
    --error-text: #ff6b6b;
    --loading-color: #a0a0a0;
    --placeholder-color: #666;
  }

  body { 
    font-family: Arial, sans-serif; 
    margin: 2rem; 
    background: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  h1 { margin-bottom: 1rem; }
  
  input { 
    padding: 0.5rem; 
    width: 100%; 
    max-width: 400px; 
    margin-bottom: 1rem; 
    font-size: 1rem;
    background: var(--input-bg);
    color: var(--text-color);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }
  
  input::placeholder {
    color: var(--placeholder-color);
  }
  
  select {
    background: var(--input-bg);
    color: var(--text-color);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }
  
  table { 
    border-collapse: collapse; 
    width: 100%; 
    background: var(--table-bg);
    transition: background-color 0.3s ease;
  }
  
  th, td { 
    border: 1px solid var(--table-border); 
    padding: 0.5rem; 
    text-align: left;
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }
  
  th { 
    background: var(--header-bg);
    transition: background-color 0.3s ease;
  }
  
  .error { 
    color: var(--error-text); 
    padding: 1rem; 
    background: var(--error-bg); 
    border: 1px solid var(--error-border); 
    border-radius: 0.25rem; 
    margin-bottom: 1rem;
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
  }
  
  .loading { 
    color: var(--loading-color); 
    padding: 1rem; 
    text-align: center;
    transition: color 0.3s ease;
  }

  .theme-toggle {
    background: var(--input-bg);
    color: var(--text-color);
    border: 1px solid var(--input-border);
    border-radius: 4px;
    padding: 0.5rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }

  .theme-toggle:hover {
    background: var(--header-bg);
  }

  a {
    color: #007bff;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  [data-theme="dark"] a {
    color: #4da6ff;
  }
</style>
</head>
<body>
<h1>Eâ€‘Number Lookup</h1>
<div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
  <input type="text" id="search" placeholder="Search by Eâ€‘number or nameâ€¦" maxlength="100" style="flex: 1; min-width: 200px;">
  <select id="sort" style="padding: 0.5rem; font-size: 1rem;">
    <option value="code">Sort by E-Number</option>
    <option value="name">Sort by Name</option>
  </select>
  <button id="theme-toggle" class="theme-toggle">ðŸŒ™ Dark Mode</button>
</div>

<div id="error-container"></div>
<div id="loading" class="loading" style="display:none;">Loading...</div>

<table id="etable">
  <thead>
    <tr><th>Eâ€‘Number</th><th>Name</th><th>Open Food Facts</th><th>Wikidata</th></tr>
  </thead>
  <tbody id="tbody">
  </tbody>
</table>

<script>
let enumbers = [];
let searchTimeout;
let currentSort = 'code';

// Security: HTML escaping function
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Security: URL validation function
function isValidUrl(string) {
  try {
    const url = new URL(string);
    return url.protocol === 'http:' || url.protocol === 'https:';
  } catch (_) {
    return false;
  }
}

// Security: Create DOM elements safely instead of using innerHTML
function createTableRow(entry) {
  const row = document.createElement('tr');
  
  // E-Number cell
  const codeCell = document.createElement('td');
  codeCell.textContent = entry.code;
  row.appendChild(codeCell);
  
  // Name cell
  const nameCell = document.createElement('td');
  nameCell.textContent = entry.name;
  row.appendChild(nameCell);
  
  // Open Food Facts cell
  const offCell = document.createElement('td');
  if (entry.openfoodfacts_additive && entry.openfoodfacts_additive.url && isValidUrl(entry.openfoodfacts_additive.url)) {
    const offLink = document.createElement('a');
    offLink.href = entry.openfoodfacts_additive.url;
    offLink.textContent = entry.openfoodfacts_additive.name || 'Open Food Facts';
    offLink.target = '_blank';
    offLink.rel = 'noopener noreferrer'; // Security: prevent window.opener access
    offCell.appendChild(offLink);
  } else if (entry.openfoodfacts_url && isValidUrl(entry.openfoodfacts_url)) {
    const offLink = document.createElement('a');
    offLink.href = entry.openfoodfacts_url;
    offLink.textContent = 'Open Food Facts (generic)';
    offLink.target = '_blank';
    offLink.rel = 'noopener noreferrer';
    offCell.appendChild(offLink);
  } else {
    const span = document.createElement('span');
    span.style.color = '#bbb';
    span.textContent = '(none)';
    offCell.appendChild(span);
  }
  row.appendChild(offCell);
  
  // Wikidata cell
  const wikiCell = document.createElement('td');
  if (entry.openfoodfacts_additive && 
      entry.openfoodfacts_additive.sameAs && 
      entry.openfoodfacts_additive.sameAs.length > 0 &&
      isValidUrl(entry.openfoodfacts_additive.sameAs[0])) {
    const wikiLink = document.createElement('a');
    wikiLink.href = entry.openfoodfacts_additive.sameAs[0];
    wikiLink.textContent = 'Wikidata';
    wikiLink.target = '_blank';
    wikiLink.rel = 'noopener noreferrer';
    wikiCell.appendChild(wikiLink);
  } else {
    const span = document.createElement('span');
    span.style.color = '#bbb';
    span.textContent = '(none)';
    wikiCell.appendChild(span);
  }
  row.appendChild(wikiCell);
  
  return row;
}

function showError(message) {
  const errorContainer = document.getElementById('error-container');
  errorContainer.innerHTML = '';
  
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error';
  errorDiv.textContent = message;
  errorContainer.appendChild(errorDiv);
}

function hideError() {
  document.getElementById('error-container').innerHTML = '';
}

function showLoading() {
  document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function renderTable(filter="") {
  const tbody = document.getElementById('tbody');
  
  // Clear existing rows
  while (tbody.firstChild) {
    tbody.removeChild(tbody.firstChild);
  }
  
  // Security: Escape filter input
  const safeFilter = filter.toLowerCase().trim();
  
  // Filter entries
  const filteredEntries = enumbers.filter(e => 
    e.code.toLowerCase().includes(safeFilter) || 
    e.name.toLowerCase().includes(safeFilter)
  );
  
  // Sort entries
  const sortedEntries = filteredEntries.sort((a, b) => {
    if (currentSort === 'code') {
      // Sort by E-number (numerical order)
      const aNum = parseInt(a.code.replace(/[^0-9]/g, ''));
      const bNum = parseInt(b.code.replace(/[^0-9]/g, ''));
      return aNum - bNum;
    } else {
      // Sort by name (alphabetical)
      return a.name.localeCompare(b.name);
    }
  });
  
  // Limit results for performance
  const limitedEntries = sortedEntries.slice(0, 500);
  
  // Create and append rows
  const fragment = document.createDocumentFragment();
  limitedEntries.forEach(entry => {
    fragment.appendChild(createTableRow(entry));
  });
  tbody.appendChild(fragment);
}

// Security: Debounced search to prevent excessive API calls
document.getElementById('search').addEventListener('input', function(e) {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    const query = e.target.value;
    // Security: Limit input length
    if (query.length > 100) {
      e.target.value = query.substring(0, 100);
      return;
    }
    renderTable(query);
  }, 300); // 300ms debounce
});

// Sort dropdown change handler
document.getElementById('sort').addEventListener('change', function(e) {
  currentSort = e.target.value;
  renderTable(document.getElementById('search').value);
});

// Theme toggle functionality
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  // Update button text
  const button = document.getElementById('theme-toggle');
  button.textContent = newTheme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
}

// Load theme from localStorage on page load
function loadTheme() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    document.documentElement.setAttribute('data-theme', savedTheme);
    const button = document.getElementById('theme-toggle');
    button.textContent = savedTheme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
  }
}

// Theme toggle handler
document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

// Load theme when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadTheme);
} else {
  loadTheme();
}

// Security: Fetch with error handling and timeout
function fetchWithTimeout(url, options = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
  
  return fetch(url, {
    ...options,
    signal: controller.signal
  }).finally(() => {
    clearTimeout(timeoutId);
  });
}

// Load data from API
showLoading();
fetchWithTimeout('/api/enumbers')
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (Array.isArray(data)) {
      enumbers = data;
      renderTable();
      hideError();
    } else {
      throw new Error('Invalid data format received');
    }
  })
  .catch(error => {
    console.error('Error loading E-numbers:', error);
    showError('Failed to load E-number data. Please try refreshing the page.');
  })
  .finally(() => {
    hideLoading();
  });
</script>
</body>
</html>
