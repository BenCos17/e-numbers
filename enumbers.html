<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>E‑Number Lookup</title>
<style>
  :root {
    --bg-color: #f8f9fa;
    --text-color: #333;
    --table-bg: white;
    --table-border: #ccc;
    --header-bg: #e9ecef;
    --input-bg: white;
    --input-border: #ccc;
    --error-bg: #f8d7da;
    --error-border: #f5c6cb;
    --error-text: #dc3545;
    --loading-color: #6c757d;
    --placeholder-color: #bbb;
    --success-color: #28a745;
    --info-color: #17a2b8;
  }

  [data-theme="dark"] {
    --bg-color: #1a1a1a;
    --text-color: #e0e0e0;
    --table-bg: #2d2d2d;
    --table-border: #444;
    --header-bg: #3d3d3d;
    --input-bg: #2d2d2d;
    --input-border: #444;
    --error-bg: #3d1f1f;
    --error-border: #5c2a2a;
    --error-text: #ff6b6b;
    --loading-color: #a0a0a0;
    --placeholder-color: #666;
    --success-color: #4caf50;
    --info-color: #2196f3;
  }

  body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    margin: 0;
    padding: 1rem;
    background: var(--bg-color);
    color: var(--text-color);
    transition: background-color 0.3s ease, color 0.3s ease;
    line-height: 1.6;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  h1 { 
    margin-bottom: 1.5rem; 
    font-size: 2rem;
    font-weight: 600;
  }
  
  .search-container {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  
  .search-input-group {
    position: relative;
    flex: 1;
    min-width: 250px;
  }
  
  .search-input {
    width: 100%;
    padding: 0.75rem 2.5rem 0.75rem 0.75rem;
    font-size: 1rem;
    background: var(--input-bg);
    color: var(--text-color);
    border: 1px solid var(--input-border);
    border-radius: 6px;
    transition: all 0.3s ease;
    box-sizing: border-box;
  }
  
  .search-input:focus {
    outline: none;
    border-color: var(--info-color);
    box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
  }
  
  .search-input::placeholder {
    color: var(--placeholder-color);
  }
  
  .clear-search {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--placeholder-color);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.25rem;
    border-radius: 50%;
    transition: all 0.2s ease;
    display: none;
  }
  
  .clear-search:hover {
    background: var(--header-bg);
    color: var(--text-color);
  }
  
  .clear-search.visible {
    display: block;
  }
  
  .controls-group {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  select {
    padding: 0.75rem;
    font-size: 1rem;
    background: var(--input-bg);
    color: var(--text-color);
    border: 1px solid var(--input-border);
    border-radius: 6px;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  select:focus {
    outline: none;
    border-color: var(--info-color);
    box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
  }
  
  .theme-toggle {
    background: var(--input-bg);
    color: var(--text-color);
    border: 1px solid var(--input-border);
    border-radius: 6px;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .theme-toggle:hover {
    background: var(--header-bg);
    border-color: var(--info-color);
  }
  
  .results-info {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: var(--info-color);
    color: white;
    border-radius: 6px;
    font-weight: 500;
    display: none;
  }
  
  .results-info.visible {
    display: block;
  }
  
  .error { 
    color: var(--error-text); 
    padding: 1rem; 
    background: var(--error-bg); 
    border: 1px solid var(--error-border); 
    border-radius: 6px; 
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }
  
  .loading { 
    color: var(--loading-color); 
    padding: 1rem; 
    text-align: center;
    transition: color 0.3s ease;
  }

  .table-container {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  table { 
    border-collapse: collapse; 
    width: 100%; 
    background: var(--table-bg);
    transition: background-color 0.3s ease;
    min-width: 600px;
  }
  
  th, td { 
    border: 1px solid var(--table-border); 
    padding: 0.75rem; 
    text-align: left;
    transition: all 0.3s ease;
  }
  
  th { 
    background: var(--header-bg);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  tr:hover {
    background: var(--header-bg);
  }
  
  a {
    color: var(--info-color);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  a:hover {
    text-decoration: underline;
    color: var(--text-color);
  }

  [data-theme="dark"] a {
    color: #4da6ff;
  }
  
  [data-theme="dark"] a:hover {
    color: #66b3ff;
  }

  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    body {
      padding: 0.5rem;
    }
    
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .search-container {
      flex-direction: column;
      align-items: stretch;
      gap: 0.75rem;
    }
    
    .search-input-group {
      min-width: auto;
    }
    
    .controls-group {
      justify-content: space-between;
    }
    
    select, .theme-toggle {
      flex: 1;
      min-width: 0;
    }
    
    .table-container {
      margin: 0 -0.5rem;
      border-radius: 0;
    }
    
    th, td {
      padding: 0.5rem;
      font-size: 0.9rem;
    }
    
    .results-info {
      margin: 0 -0.5rem 1rem -0.5rem;
      border-radius: 0;
    }
  }
  
  @media (max-width: 480px) {
    .controls-group {
      flex-direction: column;
      align-items: stretch;
    }
    
    select, .theme-toggle {
      width: 100%;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h1>E‑Number Lookup</h1>
  
  <div class="search-container">
    <div class="search-input-group">
      <input type="text" id="search" class="search-input" placeholder="Search by E-number or name..." maxlength="100">
      <button id="clear-search" class="clear-search" title="Clear search">×</button>
    </div>
    <div class="controls-group">
      <select id="sort">
        <option value="code">Sort by E-Number</option>
        <option value="name">Sort by Name</option>
      </select>
      <button id="theme-toggle" class="theme-toggle">Dark Mode</button>
    </div>
  </div>

  <div id="results-info" class="results-info"></div>
  <div id="error-container"></div>
  <div id="loading" class="loading" style="display:none;">Loading...</div>

  <div class="table-container">
    <table id="etable">
      <thead>
        <tr><th>E‑Number</th><th>Name</th><th>Open Food Facts</th><th>Wikidata</th></tr>
      </thead>
      <tbody id="tbody">
      </tbody>
    </table>
  </div>
</div>

<script>
let enumbers = [];
let searchTimeout;
let currentSort = 'code';

// Security: HTML escaping function
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Security: URL validation function
function isValidUrl(string) {
  try {
    const url = new URL(string);
    return url.protocol === 'http:' || url.protocol === 'https:';
  } catch (_) {
    return false;
  }
}

// Security: Create DOM elements safely instead of using innerHTML
function createTableRow(entry) {
  const row = document.createElement('tr');
  
  // E-Number cell
  const codeCell = document.createElement('td');
  codeCell.textContent = entry.code;
  row.appendChild(codeCell);
  
  // Name cell
  const nameCell = document.createElement('td');
  nameCell.textContent = entry.name;
  row.appendChild(nameCell);
  
  // Open Food Facts cell
  const offCell = document.createElement('td');
  if (entry.openfoodfacts_additive && entry.openfoodfacts_additive.url && isValidUrl(entry.openfoodfacts_additive.url)) {
    const offLink = document.createElement('a');
    offLink.href = entry.openfoodfacts_additive.url;
    offLink.textContent = entry.openfoodfacts_additive.name || 'Open Food Facts';
    offLink.target = '_blank';
    offLink.rel = 'noopener noreferrer'; // Security: prevent window.opener access
    offCell.appendChild(offLink);
  } else if (entry.openfoodfacts_url && isValidUrl(entry.openfoodfacts_url)) {
    const offLink = document.createElement('a');
    offLink.href = entry.openfoodfacts_url;
    offLink.textContent = 'Open Food Facts (generic)';
    offLink.target = '_blank';
    offLink.rel = 'noopener noreferrer';
    offCell.appendChild(offLink);
  } else {
    const span = document.createElement('span');
    span.style.color = '#bbb';
    span.textContent = '(none)';
    offCell.appendChild(span);
  }
  row.appendChild(offCell);
  
  // Wikidata cell
  const wikiCell = document.createElement('td');
  if (entry.openfoodfacts_additive && 
      entry.openfoodfacts_additive.sameAs && 
      entry.openfoodfacts_additive.sameAs.length > 0 &&
      isValidUrl(entry.openfoodfacts_additive.sameAs[0])) {
    const wikiLink = document.createElement('a');
    wikiLink.href = entry.openfoodfacts_additive.sameAs[0];
    wikiLink.textContent = 'Wikidata';
    wikiLink.target = '_blank';
    wikiLink.rel = 'noopener noreferrer';
    wikiCell.appendChild(wikiLink);
  } else {
    const span = document.createElement('span');
    span.style.color = '#bbb';
    span.textContent = '(none)';
    wikiCell.appendChild(span);
  }
  row.appendChild(wikiCell);
  
  return row;
}

function showError(message) {
  const errorContainer = document.getElementById('error-container');
  errorContainer.innerHTML = '';
  
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error';
  errorDiv.textContent = message;
  errorContainer.appendChild(errorDiv);
}

function hideError() {
  document.getElementById('error-container').innerHTML = '';
}

function showLoading() {
  document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function renderTable(filter="") {
  const tbody = document.getElementById('tbody');
  
  // Clear existing rows
  while (tbody.firstChild) {
    tbody.removeChild(tbody.firstChild);
  }
  
  // Security: Escape filter input
  const safeFilter = filter.toLowerCase().trim();
  
  // Filter entries
  const filteredEntries = enumbers.filter(e => 
    e.code.toLowerCase().includes(safeFilter) || 
    e.name.toLowerCase().includes(safeFilter)
  );
  
  // Sort entries
  const sortedEntries = filteredEntries.sort((a, b) => {
    if (currentSort === 'code') {
      // Sort by E-number (numerical order)
      const aNum = parseInt(a.code.replace(/[^0-9]/g, ''));
      const bNum = parseInt(b.code.replace(/[^0-9]/g, ''));
      return aNum - bNum;
    } else {
      // Sort by name (alphabetical)
      return a.name.localeCompare(b.name);
    }
  });
  
  // Limit results for performance
  const limitedEntries = sortedEntries.slice(0, 500);
  
  // Create and append rows
  const fragment = document.createDocumentFragment();
  limitedEntries.forEach(entry => {
    fragment.appendChild(createTableRow(entry));
  });
  tbody.appendChild(fragment);
}

// Security: Debounced search to prevent excessive API calls
document.getElementById('search').addEventListener('input', function(e) {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    const query = e.target.value;
    // Security: Limit input length
    if (query.length > 100) {
      e.target.value = query.substring(0, 100);
      return;
    }
    
    // Show/hide clear button
    const clearButton = document.getElementById('clear-search');
    if (query.length > 0) {
      clearButton.classList.add('visible');
    } else {
      clearButton.classList.remove('visible');
    }
    
    renderTable(query);
  }, 300); // 300ms debounce
});

// Sort dropdown change handler
document.getElementById('sort').addEventListener('change', function(e) {
  currentSort = e.target.value;
  renderTable(document.getElementById('search').value);
});

// Clear search button handler
document.getElementById('clear-search').addEventListener('click', function() {
  document.getElementById('search').value = '';
  document.getElementById('clear-search').classList.remove('visible');
  renderTable();
});

// Theme toggle functionality
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  // Update button text
  const button = document.getElementById('theme-toggle');
  button.textContent = newTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
}

// Load theme from localStorage on page load
function loadTheme() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    document.documentElement.setAttribute('data-theme', savedTheme);
    const button = document.getElementById('theme-toggle');
    button.textContent = savedTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
  }
}

// Initialize theme and event listeners when DOM is ready
function initializeTheme() {
  loadTheme();
  // Add event listener only once
  const themeButton = document.getElementById('theme-toggle');
  if (themeButton) {
    themeButton.addEventListener('click', toggleTheme);
  }
}

// Load theme when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeTheme);
} else {
  initializeTheme();
}

// Security: Fetch with error handling and timeout
function fetchWithTimeout(url, options = {}) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
  
  return fetch(url, {
    ...options,
    signal: controller.signal
  }).finally(() => {
    clearTimeout(timeoutId);
  });
}

// Load data from API
showLoading();
fetchWithTimeout('/api/enumbers')
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (Array.isArray(data)) {
      enumbers = data;
      renderTable();
      hideError();
    } else {
      throw new Error('Invalid data format received');
    }
  })
  .catch(error => {
    console.error('Error loading E-numbers:', error);
    showError('Failed to load E-number data. Please try refreshing the page.');
  })
  .finally(() => {
    hideLoading();
  });
</script>
</body>
</html>
